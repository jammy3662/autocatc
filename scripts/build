#!/bin/bash

# leave unmatched wildcards empty
shopt -s nullglob

mkdir -p generated
cd generated

SRC="../src"


clang -x c -E -P $SRC/cat.g4 > ./cat.g4 -Wno-invalid-pp-token
antlr4 cat.g4

ln -s /usr/include/antlr4-runtime .

cd ..

CLANG_FLAGS="\
-Wno-deprecated -Wno-unneeded-internal-declaration \
-fno-caret-diagnostics -ferror-limit=999 \
-std=c++17 \
-g3 \
"

GCC_FLAGS="\
-Wno-deprecated -Wno-attributes \
-fno-diagnostics-show-caret \
-fdiagnostics-urls=never \
-fdiagnostics-path-format=inline-events \
-std=c++17 \
-g3 \
"

unbuffer \
g++ $GCC_FLAGS \
	-I src -I generated -I generated/antlr4-runtime \
	generated/*.cpp \
	src/*.cc \
	-o autocatc \
	-lantlr4-runtime \
	2>&1 \
	| grep -v 'In file included' \
	| grep -v 'from'
